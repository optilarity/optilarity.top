#!/usr/bin/env php
<?php

declare(strict_types=1);

use Witals\Framework\Application;
use Witals\Framework\Console\ServeCommand;
use Witals\Framework\Contracts\RuntimeType;

define('WITALS_START', microtime(true));

// Register the Composer autoloader
require_once __DIR__ . '/vendor/autoload.php';

// Get command line arguments
$argv = $_SERVER['argv'];
$commandName = $argv[1] ?? 'help';

if (in_array($commandName, ['serve', 'server'])) {
    // Detect runtime before bootstrapping to allow WITALS_RUNTIME to affect bootstrap
    $runtime = detectRuntimeFromArgs($argv);
    if ($runtime) {
        define('WITALS_RUNTIME', $runtime->value);
    }
}

// Bootstrap the application
$app = require_once __DIR__ . '/bootstrap/app.php';

// Shift arguments to remove the command name for the handler
$remainingArgv = array_slice($argv, 2);

match ($commandName) {
    'serve', 'server' => (new ServeCommand($app))->handle($remainingArgv),
    'wordpress:zero-migrate' => handleWordPressZeroMigration($app, $remainingArgv),
    'help' => displayHelp(),
    default => exitWithUnknownCommand($commandName),
};

function detectRuntimeFromArgs(array $argv): ?RuntimeType
{
    foreach ($argv as $arg) {
        if ($arg === '--reactphp') return RuntimeType::REACTPHP;
        if ($arg === '--swoole') return RuntimeType::SWOOLE;
        if ($arg === '--openswoole') return RuntimeType::OPENSWOOLE;
        if ($arg === '--roadrunner') return RuntimeType::ROADRUNNER;
    }
    return null;
}

function displayHelp(): void
{
    echo "Witals Framework CLI\n\n";
    echo "Usage:\n";
    echo "  php witals <command> [options]\n\n";
    echo "Available commands:\n";
    echo "  serve, server    Start the application server\n";
    echo "  wordpress:zero-migrate  Migrate WordPress to PrestoWorld\n";
    echo "  help             Display this help message\n\n";
}

function handleWordPressZeroMigration($app, array $argv): void
{
    // Parse command line options
    $dryRun = in_array('--dry-run', $argv) || in_array('-d', $argv);
    $force = in_array('--force', $argv) || in_array('-f', $argv);
    
    try {
        $migration = new \PrestoWorld\Bridge\WordPress\ZeroMigration\WordPressZeroMigration();
        
        echo "ðŸš€ PrestoWorld Zero Migration\n\n";
        
        // Detect WordPress installation
        if (!$migration->detectWordPress()) {
            echo "âŒ WordPress installation not detected\n\n";
            echo "Required files:\n";
            echo "  - wp-config.php (in project root)\n";
            echo "  - wp-content/ (with themes/ and plugins/ subdirectories)\n";
            exit(1);
        }
        
        echo "âœ… WordPress installation detected\n";
        
        // Parse wp-config.php
        $wpConfig = $migration->parseWpConfig();
        if (empty($wpConfig)) {
            echo "âŒ Failed to parse wp-config.php\n";
            exit(1);
        }
        
        echo "âœ… wp-config.php parsed successfully\n\n";
        echo "Database Configuration:\n";
        foreach ($wpConfig as $key => $value) {
            echo "  {$key}: {$value}\n";
        }
        
        if ($dryRun) {
            echo "\nðŸ” Dry run mode - no changes made\n";
            exit(0);
        }
        
        // Validate database
        echo "\nðŸ” Validating WordPress database...\n";
        $validation = $migration->validateDatabase();
        
        if (isset($validation['error'])) {
            echo "âŒ Database error: {$validation['error']}\n";
            exit(1);
        }
        
        if (!$validation['valid']) {
            echo "âŒ WordPress database validation failed\n";
            echo "Missing tables:\n";
            foreach ($validation['missing_tables'] as $table) {
                echo "  - {$table}\n";
            }
            
            if (!$force) {
                echo "\nUse --force to continue anyway\n";
                exit(1);
            }
        }
        
        echo "âœ… WordPress database validated\n";
        
        // Get site info
        $siteInfo = $migration->getSiteInfo();
        if (!isset($siteInfo['error'])) {
            echo "\nðŸ“‹ Site Information:\n";
            echo "  Site URL: {$siteInfo['siteurl']}\n";
            echo "  Blog Name: {$siteInfo['blogname']}\n";
            echo "  Active Theme: {$siteInfo['active_theme']}\n";
            echo "  Posts: {$siteInfo['post_count']}\n";
            echo "  Table Prefix: {$siteInfo['table_prefix']}\n";
        }
        
        // Execute migration
        echo "\nðŸ”„ Executing zero migration...\n";
        $result = $migration->migrate();
        
        if (!$result['success']) {
            echo "âŒ Migration failed: {$result['message']}\n";
            exit(1);
        }
        
        echo "âœ… Zero migration completed successfully!\n\n";
        echo "ðŸŽ‰ Your WordPress site is now ready for PrestoWorld!\n\n";
        echo "Next steps:\n";
        echo "  1. Start the server: php witals serve\n";
        echo "  2. Visit your site\n";
        echo "  3. Test theme and plugins\n";
        
    } catch (\Exception $e) {
        echo "âŒ Migration error: {$e->getMessage()}\n";
        exit(1);
    }
}

function exitWithUnknownCommand(string $command): never
{
    echo "Unknown command: {$command}\n";
    displayHelp();
    exit(1);
}
